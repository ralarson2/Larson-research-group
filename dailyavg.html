<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PM2.5 Daily Average Concentrations – Larson Research Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --accent:#1b7c6d; --bg:#f7f9fb; --card:#ffffff; --text:#222; --border:#dde3ea; }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; margin: 0; background: var(--bg); color: var(--text); }
    main { max-width: 960px; margin: 0 auto; padding: 1.25rem 1rem 2rem; display:flex; flex-direction:column; gap:1rem; }
    h1 { font-size: 1.5rem; margin: 0; }
    p { margin: 0; color:#4b5c67; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 0.9rem; padding: 1rem 1.1rem; box-shadow: 0 8px 20px rgba(15,35,52,0.04); }
    label { display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap; }
    select { padding: 0.4rem 0.55rem; font-size: 0.95rem; border:1px solid #cfd8e3; border-radius:0.6rem; background:#fff; }
    .status { font-size: 0.9rem; color:#4b5c67; }
    .chart-wrap { height: 460px; width: 100%; }
    canvas { width:100% !important; height:100% !important; }
    table { border-collapse: collapse; width:100%; margin-top:0.75rem; font-size:0.92rem; }
    th, td { border:1px solid var(--border); padding:0.45rem; text-align:center; }
    th { background:#eef3f7; font-weight: 600; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <main>
    <div class="card">
      <h1>PM2.5 average concentrations by day of the week</h1>
      <p>Calculated from hourly AirQo data using pm2_5_calibrated_value.</p>
      <p style="margin-top:0.5rem;"><a href="uganda.html">Back to Uganda air quality</a></p>
    </div>

    <div class="card">
      <label>
        Sensor
        <select id="sensor-select"></select>
      </label>
      <div id="status" class="status" style="margin-top:0.5rem;">Loading archived data…</div>
    </div>

    <div class="card">
      <div class="chart-wrap">
        <canvas id="pm25-dow-chart"></canvas>
      </div>

      <table>
        <thead>
          <tr>
            <th>Day of the week</th>
            <th>Average PM2.5 (µg/m³)</th>
            <th>Count (hourly points)</th>
          </tr>
        </thead>
        <tbody id="tbl-body"></tbody>
      </table>
    </div>
  </main>

<script>
  const CSV_URL = "data/uganda_pm25_archive.csv"; // your archive in the repo

  const DAYS = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];

  function parseCsv(text) {
    const rows = [];
    let row = [];
    let field = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (inQuotes) {
        if (c === '"' && next === '"') { field += '"'; i++; continue; }
        if (c === '"') { inQuotes = false; continue; }
        field += c;
        continue;
      }

      if (c === '"') { inQuotes = true; continue; }
      if (c === ",") { row.push(field); field = ""; continue; }
      if (c === "\n") {
        row.push(field);
        if (row.length > 1 || row[0].trim() !== "") rows.push(row);
        row = [];
        field = "";
        continue;
      }
      if (c === "\r") continue;

      field += c;
    }

    if (field.length || row.length) {
      row.push(field);
      if (row.length > 1 || row[0].trim() !== "") rows.push(row);
    }

    return rows;
  }

  function toNumberOrNull(raw) {
    if (raw === null || raw === undefined) return null;
    const s = String(raw).trim();
    if (s === "") return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  function parseTimeMs(isoLike) {
    const d = new Date(isoLike);
    const ms = d.getTime();
    return Number.isFinite(ms) ? ms : null;
  }

  function dayOfWeekName(ms) {
    return new Date(ms).toLocaleDateString("en-US", { weekday: "long" });
  }

  let chart = null;
  let bySensor = new Map(); // sensorKey -> { label, points: [{ms, pm25}] }

  function render(sensorKey) {
    const entry = bySensor.get(sensorKey);
    if (!entry) return;

    const buckets = new Map(DAYS.map(d => [d, { sum: 0, n: 0 }]));

    for (const p of entry.points) {
      const d = dayOfWeekName(p.ms);
      const b = buckets.get(d);
      if (!b) continue;
      b.sum += p.pm25;
      b.n += 1;
    }

    const labels = DAYS.slice();
    const avgs = labels.map(d => {
      const b = buckets.get(d);
      return b && b.n ? (b.sum / b.n) : null;
    });
    const counts = labels.map(d => (buckets.get(d)?.n || 0));

    const ctx = document.getElementById("pm25-dow-chart").getContext("2d");
    if (chart) chart.destroy();

    chart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [{
          label: "PM2.5 (µg/m³)",
          data: avgs
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: (item) => {
                const v = item.raw;
                if (v === null || v === undefined) return "No data";
                return `PM2.5: ${Number(v).toFixed(1)} µg/m³`;
              }
            }
          }
        },
        scales: {
          y: { beginAtZero: true, title: { display: true, text: "PM2.5 (µg/m³)" } }
        }
      }
    });

    const tbody = document.getElementById("tbl-body");
    tbody.innerHTML = "";
    for (let i = 0; i < labels.length; i++) {
      const tr = document.createElement("tr");
      const v = avgs[i];
      tr.innerHTML = `<td>${labels[i]}</td><td>${(v === null ? "" : Number(v).toFixed(1))}</td><td>${counts[i]}</td>`;
      tbody.appendChild(tr);
    }
  }

  function populateDropdown() {
    const sel = document.getElementById("sensor-select");
    sel.innerHTML = "";

    const keys = Array.from(bySensor.keys()).sort((a,b) => {
      const la = bySensor.get(a)?.label || a;
      const lb = bySensor.get(b)?.label || b;
      return la.localeCompare(lb);
    });

    for (const k of keys) {
      const opt = document.createElement("option");
      opt.value = k;
      opt.textContent = bySensor.get(k)?.label || k;
      sel.appendChild(opt);
    }

    sel.addEventListener("change", e => render(e.target.value));

    if (keys.length) render(keys[0]);
  }

  async function load() {
    const statusEl = document.getElementById("status");
    try {
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error(`Archive CSV not found: ${CSV_URL} (HTTP ${res.status})`);

      const text = await res.text();
      const rows = parseCsv(text);
      if (rows.length < 2) throw new Error("Archive CSV is empty");

      const header = rows[0].map(h => h.trim());

      const idxDatetime = header.indexOf("datetime");
      const idxDeviceName = header.indexOf("device_name");
      const idxSiteName = header.indexOf("site_name");
      const idxPm25Cal = header.indexOf("pm2_5_calibrated_value");

      if (idxDatetime < 0 || idxDeviceName < 0 || idxPm25Cal < 0) {
        throw new Error("CSV header does not include datetime, device_name, and pm2_5_calibrated_value");
      }

      bySensor = new Map();

      for (let r = 1; r < rows.length; r++) {
        const cols = rows[r];
        const t = cols[idxDatetime];
        const ms = parseTimeMs(t);
        if (ms === null) continue;

        const pm25 = toNumberOrNull(cols[idxPm25Cal]);
        if (pm25 === null) continue;

        const device = String(cols[idxDeviceName] || "").trim();
        if (!device) continue;

        const site = idxSiteName >= 0 ? String(cols[idxSiteName] || "").trim() : "";
        const label = site || device;

        if (!bySensor.has(device)) bySensor.set(device, { label, points: [] });
        bySensor.get(device).points.push({ ms, pm25 });
      }

      for (const v of bySensor.values()) v.points.sort((a,b) => a.ms - b.ms);

      if (!bySensor.size) throw new Error("No usable pm2_5_calibrated_value rows found");

      statusEl.textContent = "";
      populateDropdown();
    } catch (e) {
      console.error(e);
      statusEl.textContent = "Could not load archived data for daily averages.";
    }
  }

  load();
</script>
</body>
</html>
