<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>PM2.5 Daily Average Concentrations – Larson Research Group</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f7f9fb;
      color: #222;
      margin: 1rem;
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 0.5rem;
    }

    label {
      font-weight: 500;
      margin-right: 0.5rem;
    }

    select {
      padding: 0.35rem 0.5rem;
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    .chart-container {
      width: 100%;
      max-width: 960px;
      margin-bottom: 1.5rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      max-width: 960px;
      margin-top: 0.5rem;
    }

    th, td {
      border: 1px solid #dde3ea;
      padding: 0.5rem;
      text-align: center;
    }

    th {
      background: #eef3f7;
    }
  </style>
</head>

<body>
  <h1>PM2.5 Daily Average Concentrations</h1>
  <p>Select a sensor location to view average PM2.5 concentrations by day of the week.</p>

  <label for="sensorSelect">Sensor:</label>
  <select id="sensorSelect"></select>

  <div class="chart-container">
    <canvas id="pm25Chart"></canvas>
  </div>

  <table>
    <thead>
      <tr>
        <th>Day of the Week</th>
        <th>Average PM2.5 (µg/m³)</th>
      </tr>
    </thead>
    <tbody id="pm25TableBody"></tbody>
  </table>

<script>
/* =========================
   Configuration
========================= */

const DATA_URL = "historical_pm25.csv";  // update filename if needed

const DAYS = [
  "Sunday", "Monday", "Tuesday",
  "Wednesday", "Thursday", "Friday", "Saturday"
];

/* =========================
   State
========================= */

let rawData = [];
let chart = null;

/* =========================
   Helpers
========================= */

function parseCSV(text) {
  const lines = text.trim().split("\n");
  const headers = lines[0].split(",");

  return lines.slice(1).map(line => {
    const values = line.split(",");
    const row = {};
    headers.forEach((h, i) => row[h.trim()] = values[i]?.trim());
    return row;
  });
}

function getDayOfWeek(dateString) {
  const d = new Date(dateString);
  return DAYS[d.getDay()];
}

function average(arr) {
  return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0;
}

function formatNumber(v) {
  return Number.isFinite(v) ? v.toFixed(1) : "";
}

/* =========================
   Data Processing
========================= */

function getSensors(data) {
  return [...new Set(data.map(d => d.device_name))].sort();
}

function computeDailyAverages(sensor) {
  const buckets = {
    Sunday: [], Monday: [], Tuesday: [],
    Wednesday: [], Thursday: [], Friday: [], Saturday: []
  };

  rawData
    .filter(d => d.device_name === sensor)
    .forEach(d => {
      const pm = Number(d.pm2_5_calibrated_value);
      if (!Number.isFinite(pm)) return;
      const day = getDayOfWeek(d.datetime);
      buckets[day].push(pm);
    });

  return DAYS.map(day => ({
    day,
    avg: average(buckets[day])
  }));
}

/* =========================
   Rendering
========================= */

function renderChart(data) {
  const ctx = document.getElementById("pm25Chart");

  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "bar",
    data: {
      labels: data.map(d => d.day),
      datasets: [{
        data: data.map(d => d.avg),
        backgroundColor: "#1b7c6d"
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: "PM2.5 (µg/m³)"
          }
        }
      }
    }
  });
}

function renderTable(data) {
  const tbody = document.getElementById("pm25TableBody");
  tbody.innerHTML = "";

  data.forEach(d => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.day}</td>
      <td>${formatNumber(d.avg)}</td>
    `;
    tbody.appendChild(row);
  });
}

/* =========================
   Initialization
========================= */

async function init() {
  const response = await fetch(DATA_URL);
  const text = await response.text();
  rawData = parseCSV(text);

  const sensors = getSensors(rawData);
  const select = document.getElementById("sensorSelect");

  sensors.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s;
    opt.textContent = s;
    select.appendChild(opt);
  });

  function update() {
    const daily = computeDailyAverages(select.value);
    renderChart(daily);
    renderTable(daily);
  }

  select.addEventListener("change", update);

  select.value = sensors[0];
  update();
}

init();
</script>
</body>
</html>
