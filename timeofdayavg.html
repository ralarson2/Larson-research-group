<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Uganda air quality – Time-of-day averages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:#f7f9fb;color:#222;margin:0;}
    .wrap{max-width:960px;margin:0 auto;padding:1.5rem 1rem 2.5rem;}
    .card{background:#fff;border:1px solid #dde3ea;border-radius:14px;padding:1rem 1.1rem;box-shadow:0 8px 20px rgba(15,35,52,0.04);}
    h1{margin:0 0 .35rem 0;font-size:1.4rem;color:#143541;}
    p{margin:.25rem 0 .9rem 0;color:#4b5c67;max-width:52rem;line-height:1.5;}
    .toolbar{display:flex;gap:.75rem;flex-wrap:wrap;align-items:center;margin:.8rem 0 1rem 0;}
    select{padding:.45rem .55rem;border-radius:10px;border:1px solid #cfd8e3;background:#fff;}
    canvas{width:100% !important;height:520px !important;}
    a{color:#1b7c6d;text-decoration:none;}
    a:hover{text-decoration:underline;}
    .small{font-size:.9rem;color:#4b5c67;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Average by time of day (by sensor)</h1>
      <p>
        This chart groups archived measurements by hour of day in Kampala time (EAT, UTC+3), then averages within each hour.
        Use the dropdown to switch pollutant.
      </p>

      <div class="toolbar">
        <label class="small">
          Pollutant
          <select id="pollutant">
            <option value="pm25">PM2.5 (calibrated)</option>
            <option value="pm10">PM10 (calibrated)</option>
          </select>
        </label>
        <div class="small">
          <a href="uganda_air_quality.html">Back to main page</a>
        </div>
        <div class="small" id="meta"></div>
      </div>

      <canvas id="todChart"></canvas>
    </div>
  </div>

<script>
  const ARCHIVE_CSV_URL = "data/uganda_pm25_archive.csv";

  function normalizeDeviceId(raw) {
    if (!raw) return "";
    const s = String(raw).trim().toLowerCase();
    if (s.startsWith("aq_g5_")) return s;
    if (s.startsWith("aq_g")) return s;
    if (s.startsWith("aq_")) return s;
    if (s.startsWith("airqo_g")) return s;
    return s.replace(/[^a-z0-9_]/g, "_");
  }

  function parseCsv(text) {
    const rows = [];
    let row = [];
    let field = "";
    let inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      const next = text[i + 1];

      if (inQuotes) {
        if (c === '"' && next === '"') { field += '"'; i++; continue; }
        if (c === '"') { inQuotes = false; continue; }
        field += c;
        continue;
      }

      if (c === '"') { inQuotes = true; continue; }
      if (c === ",") { row.push(field); field = ""; continue; }
      if (c === "\n") {
        row.push(field);
        if (row.length > 1 || row[0].trim() !== "") rows.push(row);
        row = [];
        field = "";
        continue;
      }
      if (c === "\r") continue;
      field += c;
    }

    if (field.length || row.length) {
      row.push(field);
      if (row.length > 1 || row[0].trim() !== "") rows.push(row);
    }
    return rows;
  }

  function getKampalaHour(isoLike) {
    const d = new Date(isoLike);
    if (isNaN(d.getTime())) return null;
    const parts = new Intl.DateTimeFormat("en-GB", {
      timeZone: "Africa/Kampala",
      hour: "2-digit",
      hour12: false
    }).formatToParts(d);
    const h = parts.find(p => p.type === "hour")?.value;
    const n = Number(h);
    return Number.isFinite(n) ? n : null;
  }

  let chart = null;

  async function loadAndRender() {
    const pollutantSel = document.getElementById("pollutant");
    const metaEl = document.getElementById("meta");
    const canvas = document.getElementById("todChart");

    const res = await fetch(ARCHIVE_CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`Archive CSV not found: ${ARCHIVE_CSV_URL} (HTTP ${res.status})`);
    const text = await res.text();
    const rows = parseCsv(text);
    if (rows.length < 2) throw new Error("Archive CSV is empty");

    const header = rows[0].map(h => h.trim());
    const idxDatetime = header.indexOf("datetime");
    const idxDeviceName = header.indexOf("device_name");
    const idxPm25Cal = header.indexOf("pm2_5_calibrated_value");
    const idxPm10Cal = header.indexOf("pm10_calibrated_value");

    if (idxDatetime < 0 || idxDeviceName < 0 || idxPm25Cal < 0) {
      throw new Error("CSV header missing required columns (datetime, device_name, pm2_5_calibrated_value).");
    }

    const bucketsByDevice = new Map(); // device -> hour -> {sum,count}
    let minT = null, maxT = null;

    const pollutantKey = () => (pollutantSel.value === "pm10" ? "pm10" : "pm25");

    function addPoint(device, hour, val) {
      if (!bucketsByDevice.has(device)) bucketsByDevice.set(device, new Map());
      const hm = bucketsByDevice.get(device);
      if (!hm.has(hour)) hm.set(hour, { sum: 0, count: 0 });
      const b = hm.get(hour);
      b.sum += val;
      b.count += 1;
    }

    function rebuildBuckets() {
      bucketsByDevice.clear();
      minT = null; maxT = null;

      for (let r = 1; r < rows.length; r++) {
        const cols = rows[r];
        const dt = cols[idxDatetime] ?? "";
        const deviceName = cols[idxDeviceName] ?? "";
        const device = normalizeDeviceId(deviceName);
        if (!dt || !device) continue;

        const hour = getKampalaHour(dt);
        if (hour === null) continue;

        const val =
          pollutantKey() === "pm10"
            ? Number((idxPm10Cal >= 0 ? cols[idxPm10Cal] : NaN))
            : Number(cols[idxPm25Cal]);

        if (!Number.isFinite(val) || val <= 0) continue;

        addPoint(device, hour, val);

        const t = new Date(dt).getTime();
        if (Number.isFinite(t)) {
          if (minT === null || t < minT) minT = t;
          if (maxT === null || t > maxT) maxT = t;
        }
      }
    }

    function datasetsFromBuckets() {
      const datasets = [];
      for (const [device, hm] of bucketsByDevice.entries()) {
        const points = [];
        for (let h = 0; h < 24; h++) {
          const b = hm.get(h);
          if (!b || !b.count) continue;
          points.push({ x: h, y: b.sum / b.count });
        }
        points.sort((a,b) => a.x - b.x);
        datasets.push({
          label: device,
          data: points,
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.2,
          spanGaps: true,
          showLine: true
        });
      }
      return datasets;
    }

    function render() {
      rebuildBuckets();
      const datasets = datasetsFromBuckets();

      if (chart) chart.destroy();
      chart = new Chart(canvas, {
        type: "line",
        data: { datasets },
        options: {
          responsive: true,
          parsing: false,
          maintainAspectRatio: false,
          interaction: { mode: "nearest", intersect: false },
          scales: {
            x: {
              type: "linear",
              min: 0,
              max: 23,
              ticks: { stepSize: 1 },
              title: { display: true, text: "Hour of day (EAT, UTC+3)" }
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: pollutantSel.value === "pm10" ? "PM10 (µg/m³, calibrated)" : "PM2.5 (µg/m³, calibrated)"
              }
            }
          },
          plugins: {
            legend: { display: true, position: "top" }
          }
        }
      });

      if (minT !== null && maxT !== null) {
        const minD = new Date(minT);
        const maxD = new Date(maxT);
        const fmt = (d) => d.toLocaleString("en-GB", {
          timeZone: "Africa/Kampala",
          year: "numeric",
          month: "short",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        }).replace(",", "");
        metaEl.textContent = `Archive range: ${fmt(minD)} to ${fmt(maxD)} (EAT)`;
      } else {
        metaEl.textContent = "";
      }
    }

    pollutantSel.addEventListener("change", render);
    render();
  }

  loadAndRender().catch(err => {
    console.error(err);
    document.getElementById("meta").textContent = "Could not load archive CSV.";
  });
</script>
</body>
</html>
