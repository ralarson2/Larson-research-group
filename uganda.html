<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Larson Research Group – Uganda air quality</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --accent: #1b7c6d;
      --accent-light: #e2f3f0;
      --dark: #143541;
      --text: #222222;
      --bg: #f7f9fb;
      --card: #ffffff;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
    }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    header {
      background: var(--card);
      border-bottom: 1px solid #dde3ea;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .nav-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
    }

    .nav-title {
      font-size: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--dark);
      white-space: nowrap;
    }

    .nav-links {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.9rem;
    }

    .nav-links a {
      padding-bottom: 0.15rem;
      border-bottom: 2px solid transparent;
    }

    .nav-links a:hover {
      border-color: var(--accent);
      text-decoration: none;
    }

    .hero {
      background: radial-gradient(circle at top left, var(--accent-light), var(--bg));
      border-bottom: 1px solid #dde3ea;
    }

    .hero-inner {
      max-width: 960px;
      margin: 0 auto;
      padding: 2.4rem 1rem;
    }

    main {
      max-width: 960px;
      margin: 0 auto;
      padding: 2.2rem 1rem 2.2rem;
    }

    .section-title {
      font-size: 1.3rem;
      color: var(--dark);
      margin-bottom: 0.4rem;
    }

    .section-text {
      font-size: 0.96rem;
      margin-bottom: 0.8rem;
      max-width: 44rem;
    }

    .card {
      background: var(--card);
      border-radius: 0.9rem;
      border: 1px solid #dde3ea;
      padding: 1.1rem 1.25rem;
      box-shadow: 0 8px 20px rgba(15,35,52,0.04);
      margin-top: 0.7rem;
    }

    #uganda-data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    #uganda-data-table th,
    #uganda-data-table td {
      border: 1px solid #dde3ea;
      padding: 0.45rem 0.55rem;
      text-align: left;
      vertical-align: top;
    }

    #uganda-data-table th {
      background: #eef3f7;
      font-weight: 500;
      white-space: nowrap;
    }

    #uganda-status {
      font-size: 0.88rem;
      margin-top: 0.2rem;
      color: #4b5c67;
    }

    tr.aq_who_g1 td { background: #eef7f1; }   /* ≤15 */
    tr.aq_who_it4 td { background: #f6f7e8; }  /* 15–25 */
    tr.aq_who_it3 td { background: #fff2e2; }  /* 25–37.5 */
    tr.aq_who_it2 td { background: #ffe6e6; }  /* 37.5–50 */
    tr.aq_who_it1 td { background: #f1e6ff; }  /* 50–75 */
    tr.aq_who_high td { background: #e2e2e2; } /* >75 */

    .legend {
      margin-top: 0.85rem;
      padding: 0.75rem 0.85rem;
      border: 1px solid #dde3ea;
      border-radius: 0.75rem;
      background: #fafbfd;
      font-size: 0.85rem;
      color: #4b5c67;
    }

    .legend-title {
      color: #2f3e47;
      margin-bottom: 0.45rem;
      font-size: 0.9rem;
    }

    .legend-items {
      display: flex;
      flex-wrap: wrap;
      gap: 0.55rem 0.8rem;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
    }

    .swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.08);
    }

    #uganda-map {
      width: 100%;
      height: 420px;
      margin-top: 0.6rem;
      border-radius: 0.9rem;
      border: 1px solid #dde3ea;
    }

    footer {
      border-top: 1px solid #dde3ea;
      padding: 1.2rem 1rem 2rem 1rem;
      font-size: 0.8rem;
      color: #6b7c88;
      margin-top: 2rem;
    }

    .footer-inner {
      max-width: 960px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 0.35rem;
      text-align: center;
    }

    @media (max-width: 720px) {
      .nav-inner { flex-direction: column; align-items: flex-start; }
      .nav-links { justify-content: flex-start; }
    }
  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body>
  <header>
    <div class="nav-inner">
      <div class="nav-title">Larson Research Group</div>
      <nav class="nav-links">
        <a href="index.html#about">About</a>
        <a href="uganda.html">Uganda air quality</a>
        <a href="factsheets.html">Fact sheets</a>
        <a href="index.html#people">People</a>
        <a href="index.html#contact">Contact</a>
      </nav>
    </div>
  </header>

  <section class="hero">
    <div class="hero-inner">
      <div class="section-title">Uganda air quality project</div>
      <p class="section-text">
        Low-cost sensors and modeling to understand urban air quality in Kampala, Uganda.
      </p>
    </div>
  </section>

  <main>
    <section>
      <div class="section-title">Recent measurements</div>

      <div class="card">
        <div id="uganda-status">Loading data from AirQo…</div>

        <table id="uganda-data-table" style="display:none;">
          <thead>
            <tr>
              <th>Location</th>
              <th>Date &amp; time (Africa/Kampala)</th>
              <th>PM2.5 (µg/m³)</th>
              <th>PM10 (µg/m³)</th>
            </tr>
          </thead>
          <tbody id="uganda-data-body"></tbody>
        </table>

        <div class="legend" aria-label="PM2.5 legend">
          <div class="legend-title">
            Row and marker shading based on WHO PM2.5 (24-hour) guideline and interim targets
          </div>
          <div class="legend-items">
            <div class="legend-item">
              <span class="swatch" style="background:#eef7f1;"></span>
              ≤15 µg/m³ — Good
            </div>
            <div class="legend-item">
              <span class="swatch" style="background:#f6f7e8;"></span>
              15–25 µg/m³ — Moderate
            </div>
            <div class="legend-item">
              <span class="swatch" style="background:#fff2e2;"></span>
              25–37.5 µg/m³ — Elevated
            </div>
            <div class="legend-item">
              <span class="swatch" style="background:#ffe6e6;"></span>
              37.5–50 µg/m³ — High
            </div>
            <div class="legend-item">
              <span class="swatch" style="background:#f1e6ff;"></span>
              50–75 µg/m³ — Very high
            </div>
            <div class="legend-item">
              <span class="swatch" style="background:#e2e2e2;"></span>
              &gt;75 µg/m³ — Extremely high
            </div>
          </div>
        </div>
      </div>

      <div class="section-title" style="margin-top:1.6rem;">
        Map of PM2.5 (µg/m³) concentrations
      </div>
      <div id="uganda-map"></div>

      <div class="card" style="margin-top:1.2rem; font-size:0.9rem;">
        <div style="color:var(--dark); font-size:0.95rem; margin-bottom:0.35rem;">
          Funding and data acknowledgment
        </div>
        <div style="color:#4b5c67;">
          This work is supported by EPIC at the University of Chicago. Air quality data are provided by AirQo through its open data access program.
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-inner">
      <div>Larson Research Group · University of Wisconsin–Madison</div>
      <div>Hosted on GitHub Pages</div>
    </div>
  </footer>

  <script>
    const TOKEN = "V6ZFRJXEAGRKRSYU";
    const COHORT_ID = "68d4e669670d2e0013c85375";

    const locationLabels = {
      "airqo_g5563": { name: "Bulange Mengo", district: "Kampala" },
      "airqo_g5567": { name: "Kamwokya Oldkiira", district: "Kampala" },
      "aq_43": { name: "Makindye, Lukuli Makindye", district: "Kampala" },
      "aq_72": { name: "Luwafu, Makindye", district: "Kampala" },
      "aq_g520": { name: "Wabigalo", district: "Kampala" },
      "airqo_g5548": { name: "Mbuya Nadiope", district: "Kampala" },
      "airqo_g5438": { name: "St. Ponsiano Primary School, Makindye", district: "Kampala" },
      "airqo_g5446": { name: "Kitintale Ntensibe", district: "Kampala" },
      "airqo_g5564": { name: "Busabala, Wakiso", district: "Kampala" },
      "aq_g5_43": { name: "Katwe 1, Makindye", district: "Kampala" },
      "aq_g5_46": { name: "Ggaba, Makindye", district: "Kampala" },
      "aq_g5_48": { name: "Kabalagala Town, Makindye", district: "Kampala" },
      "aq_g5_53": { name: "Kansanga Seed Secondary School", district: "Kampala" },
      "aq_g5_97": { name: "Mbuya II, Nakawa", district: "Kampala" },
      "airqo_g5449": { name: "Rustic Expeditions Muyenga", district: "Kampala" }
    };

    function whoClassFromPM25(pm25) {
      if (pm25 <= 15) return "aq_who_g1";
      if (pm25 <= 25) return "aq_who_it4";
      if (pm25 <= 37.5) return "aq_who_it3";
      if (pm25 <= 50) return "aq_who_it2";
      if (pm25 <= 75) return "aq_who_it1";
      return "aq_who_high";
    }

    function whoColorFromClass(cls) {
      if (cls === "aq_who_g1") return "#eef7f1";
      if (cls === "aq_who_it4") return "#f6f7e8";
      if (cls === "aq_who_it3") return "#fff2e2";
      if (cls === "aq_who_it2") return "#ffe6e6";
      if (cls === "aq_who_it1") return "#f1e6ff";
      return "#e2e2e2";
    }

    function fmtNumber(v) {
      const n = Number(v);
      if (!Number.isFinite(n)) return "";
      return n.toFixed(1);
    }

    function fmtDateTimeKampala(isoLike) {
      if (!isoLike) return "";
      const d = new Date(isoLike);
      if (isNaN(d.getTime())) return String(isoLike);

      return d.toLocaleString("en-GB", {
        timeZone: "Africa/Kampala",
        year: "numeric",
        month: "short",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: false
      }).replace(",", "");
    }

    function extractLatLon(obj) {
      const latCandidates = [
        obj?.latitude,
        obj?.lat,
        obj?.approximate_latitude,
        obj?.location?.latitude,
        obj?.location?.lat,
        obj?.site?.approximate_latitude,
        obj?.site?.latitude
      ];
      const lonCandidates = [
        obj?.longitude,
        obj?.lon,
        obj?.lng,
        obj?.approximate_longitude,
        obj?.location?.longitude,
        obj?.location?.lon,
        obj?.location?.lng,
        obj?.site?.approximate_longitude,
        obj?.site?.longitude
      ];

      const lat = latCandidates.map(Number).find(v => Number.isFinite(v));
      const lon = lonCandidates.map(Number).find(v => Number.isFinite(v));
      if (Number.isFinite(lat) && Number.isFinite(lon)) return { lat, lon };
      return null;
    }

    let map;
    let markersLayer;

    function initMap() {
      map = L.map("uganda-map").setView([0.3136, 32.5811], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "&copy; OpenStreetMap contributors"
      }).addTo(map);

      markersLayer = L.layerGroup().addTo(map);
    }

    async function fetchDeviceMetadata() {
      const url = `https://api.airqo.net/api/v2/devices/metadata/devices?token=${encodeURIComponent(TOKEN)}`;
      const res = await fetch(url);
      if (!res.ok) return [];
      const data = await res.json();
      return data.devices || data.results || [];
    }

    async function loadUgandaData() {
      const tbody = document.getElementById("uganda-data-body");
      const statusEl = document.getElementById("uganda-status");
      const table = document.getElementById("uganda-data-table");

      statusEl.textContent = "Loading data from AirQo…";

      try {
        const [devicesMeta, measurementsRes] = await Promise.all([
          fetchDeviceMetadata(),
          fetch(`https://api.airqo.net/api/v2/devices/measurements/cohorts/${COHORT_ID}?token=${encodeURIComponent(TOKEN)}`)
        ]);

        if (!measurementsRes.ok) throw new Error("Measurements request failed");
        const measurementsData = await measurementsRes.json();
        const measurements = (measurementsData.measurements || measurementsData.results || []).slice(0, 15);

        const metaByName = {};
        devicesMeta.forEach(d => {
          const key = d?.name || d?.device || d?.device_name || d?.device_id;
          if (key) metaByName[String(key)] = d;
        });

        tbody.innerHTML = "";
        markersLayer.clearLayers();

        const bounds = [];

        measurements.forEach(item => {
          const deviceName = String(item.device || item.device_id || item.name || "");
          const label = locationLabels[deviceName] || { name: deviceName || "Unknown", district: "" };

          const pm25 = Number(item?.pm2_5?.value);
          const pm10 = Number(item?.pm10?.value);
          const when = fmtDateTimeKampala(item.time || item.created_at || item.timestamp);

          const tr = document.createElement("tr");
          if (Number.isFinite(pm25)) tr.className = whoClassFromPM25(pm25);

          tr.innerHTML = `
            <td>
              <div>${label.name}</div>
              <div style="font-size:0.8em;color:#4b5c67;">${label.district ? (label.district + ", Uganda") : "Uganda"}</div>
            </td>
            <td>${when}</td>
            <td>${Number.isFinite(pm25) ? pm25.toFixed(1) : ""}</td>
            <td>${Number.isFinite(pm10) ? pm10.toFixed(1) : ""}</td>
          `;
          tbody.appendChild(tr);

          const meta = metaByName[deviceName];
          const coord = extractLatLon(meta) || extractLatLon(item);

          if (coord && Number.isFinite(coord.lat) && Number.isFinite(coord.lon) && Number.isFinite(pm25)) {
            const cls = whoClassFromPM25(pm25);
            const fill = whoColorFromClass(cls);

            const marker = L.circleMarker([coord.lat, coord.lon], {
              radius: 10,
              color: "#6b7c88",
              weight: 1,
              fillColor: fill,
              fillOpacity: 0.95
            });

            const popupHtml = `
              <div style="font-family:system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;">
                <div style="color:#143541; margin-bottom:4px;">${label.name}</div>
                <div style="color:#4b5c67; font-size:12px; margin-bottom:6px;">${label.district ? (label.district + ", Uganda") : "Uganda"}</div>
                <div style="font-size:13px;">PM2.5: ${fmtNumber(pm25)} µg/m³</div>
                <div style="font-size:13px;">PM10: ${fmtNumber(pm10)} µg/m³</div>
                <div style="color:#4b5c67; font-size:12px; margin-top:6px;">${when} (Africa/Kampala)</div>
              </div>
            `;
            marker.bindPopup(popupHtml);
            marker.addTo(markersLayer);
            bounds.push([coord.lat, coord.lon]);
          }
        });

        statusEl.textContent = "";
        table.style.display = "";

        if (bounds.length >= 2) {
          map.fitBounds(bounds, { padding: [25, 25] });
        } else if (bounds.length === 1) {
          map.setView(bounds[0], 13);
        } else {
          statusEl.textContent = "Loaded measurements, but no coordinates were returned for map markers.";
        }
      } catch (e) {
        statusEl.textContent = "Could not load data from AirQo right now.";
      }
    }

    initMap();
    loadUgandaData();
  </script>
</body>
</html>


